name: Trigger GitLab (Python CI-hub)

on:
  push:
    branches: [ "main" ]

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger GitLab and fail loudly
        shell: bash
        env:
          GL_URL: ${{ secrets.GITLAB_URL }}
          GL_PID: ${{ secrets.GITLAB_PROJECT_ID }}
          GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          PAYLOAD: |
            {"ref":"main","variables":[
              {"key":"LANGUAGE","value":"python"},
              {"key":"REPO_URL","value":"https://github.com/AarifRahaman/python-Nproject_demo.git"},
              {"key":"SUBDIR","value":"weather-poetry"}
            ]}
        run: |
          set -euo pipefail
          URL="$GL_URL/api/v4/projects/$GL_PID/pipeline"
          code=$(curl -sS -o /tmp/body.json -w '%{http_code}' \
            -H "PRIVATE-TOKEN: $GL_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$URL")
          echo "GitLab API status: $code"
          echo "GitLab API body:"
          cat /tmp/body.json
          test "$code" = "201"
